<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/template.xhtml">
                

    <ui:define name="title">Contrat</ui:define>

    <ui:define name="head">
         <style >
           /* panel full width */
.full-width-panel {
    width: 100% !important;
}

/* scroll vertical pour la timeline */
.timeline-scroll {
    max-height: 500px; /* Hauteur du panel avant scroll */
    overflow-y: auto;
    padding-right: 10px; /* Pour éviter que la scrollbar chevauche le contenu */
}

/* timeline ligne verticale */
.timeline-container, .timeline-scroll {
    position: relative;
    margin-left: 20px;
    padding-left: 20px;
    border-left: 3px solid #0d6efd;
    width: 100%;
}

/* items */
.timeline-item {
    margin-bottom: 1.5rem;
    position: relative;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -10px;
    top: 0;
    width: 15px;
    height: 15px;
    background-color: #0d6efd;
    border-radius: 50%;
    border: 3px solid white;
}

.timeline-date {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 0.3rem;
}

.timeline-date .date-label {
    font-weight: bold;
    margin-right: 3px;
}

.timeline-content {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 6px;
    white-space: pre-line;
    line-height: 1.5;
    width: 100%;
}

.created-by {
    font-weight: bold;
    margin-right: 5px;
}

.note-text {
    margin-top: 0.5rem;
}
                       
         </style>
        <h:outputScript name="js/chart.js" library="demo"/>
        
        <script type="text/javascript">
        
		$(function () {
		    new Chart(document.getElementById("dashboard-chart"), {
		        type: 'bubble',
		        data: {
		            datasets: [
		                {
		                    label: "Demandeurs d'emploi",
		                    backgroundColor: "#36a2eb",
		                    borderColor: "#36a2eb",
		                    data: [
		                        { x: 1, y: 12450, r: 15 } // r = taille de la bulle
		                    ]
		                },
		                {
		                    label: "Offres d'emploi",
		                    backgroundColor: "#4bc0c0",
		                    borderColor: "#4bc0c0",
		
		                    data: [
		                        { x: 2, y: 3215, r: 10 }
		                    ]
		                },
		                {
		                    label: "Placements réussis",
		                    backgroundColor: "#ffce56",
		                    borderColor: "#ffce56",
		                    data: [
		                        { x: 3, y: 1020, r: 8 }
		                    ]
		                },
		                {
		                    label: "Formations suivies",
		                    backgroundColor: "#ff6384",
		                    borderColor: "#ff6384",
		                    data: [
		                        { x: 4, y: 450, r: 6 }
		                    ]
		                }
		            ]
		        },
		        options: {
		            responsive: true,
		            plugins: {
		                legend: {
		                    display: true,
		                    position: 'bottom'
		                },
		                title: {
		                    display: true,
		                    text: 'Tableau de performance des indicateurs',
		                    font: {
		                        size: 16
		                    }
		                }
		            },
		            scales: {
		                x: {
		                    title: {
		                        display: true,
		                        text: 'Indicateurs'
		                    },
		                    ticks: {
		                        callback: function(value, index) {
		                            const labels = ["Demandeurs", "Offres", "Placements", "Formations"];
		                            return labels[index] || '';
		                        }
		                    }
		                },
		                y: {
		                    title: {
		                        display: true,
		                        text: 'Nombre'
		                    },
		                    beginAtZero: true
		                }
		            },
		            layout: {
		                padding: 20
		            }
		        }
		    });
		});
</script>
        
    </ui:define>

    <ui:define name="content">
    
        
    
        <div class="grid layout-dashboard">
        
        
        
            <div class="col-12">
                <div class="card status">
                    <div class="status-header">
                        <div class="title">
                            <!-- 
                            Bienvenu #{securityContextImpl.utilisateur.nomprenom}
                             -->
                             ::: Contrats Stage
                        </div>
                        <div class="icons">
                            
                            
                            
                            <!-- ouvrir sous forme de popUp -->
                            
                            
                            
                            
                            <div class="icon">
                                <i class="pi pi-comments"/>
                            </div>
                            <div class="icon">
                                <i class="pi pi-window-maximize"/>
                            </div>
                            <div class="icon">
                                <i class="pi pi-bookmark"/>
                            </div>
                            
                            
                        </div>
                    </div>
                    
                </div>
            </div>
            
<!--            
             <div class="col-12 xl:col-3 md:col-6">
                <div class="grid grid-nogutter status-box status-box-3">
                    <div class="col-4 status-box-image">
                        <p:graphicImage name="images/dashboard/icon-checkins.png" library="siberia-layout"/>
                    </div>
                    <div class="col-6 status-box-text">
                        <h5>Demandeurs inscrits</h5>
                        <span>12 450</span>
                    </div>
                    <div class="col-2 status-box-icon">
                        <i class="pi pi-user-edit"/>
                    </div>
                </div>
            </div>  
            
            <div class="col-12 xl:col-3 md:col-6">
                <div class="grid grid-nogutter status-box status-box-2">
                    <div class="col-4 status-box-image">
                        <p:graphicImage name="images/dashboard/icon-filessynced.png" library="siberia-layout"/>
                    </div>
                    <div class="col-6 status-box-text">
                        <h5>Placements réussis</h5>
                        <span>1 020</span>
                    </div>
                    <div class="col-2 status-box-icon">
                        <i class="pi pi-folder"/>
                    </div>
                </div>
            </div>
            
            <div class="col-12 xl:col-3 md:col-6">
                <div class="grid grid-nogutter status-box status-box-4">
                    <div class="col-4 status-box-image">
                        <p:graphicImage name="images/dashboard/icon-useronline.png" library="siberia-layout"/>
                    </div>
                    <div class="col-6 status-box-text">
			            <h5>Formations suivies</h5>
			            <span>450</span>
                    </div>
                    <div class="col-2 status-box-icon">
                        <i class="pi pi-folder-open"/>
                    </div>
                </div>
            </div>  
            
			<div class="col-12 xl:col-3 md:col-6">
                <div class="grid grid-nogutter status-box status-box-1">
                    <div class="col-4 status-box-image">
                        <p:graphicImage name="images/dashboard/icon-message.png" library="siberia-layout"/>
                    </div>
                    <div class="col-6 status-box-text">
                        <h5>Offres disponibles</h5>
                        <span>3 215</span>
                    </div>
                    <div class="col-2 status-box-icon">
                        <i class="pi pi-users"/>
                    </div>
                </div>
            </div>
 

 --> 
 
            
<!--  -->  

			<div class="card">
			<h:form  class="card" id="form">


<p:fieldset legend="Options de Recherche et Filtres" toggleable="true" toggleSpeed="500">
            
    
        <div class="ui-fluid formgrid grid">
            <div class="field col-12 md:col-4">
                <p:outputLabel for="@next" value=": Statut"/>
                <p:selectOneMenu id="option" value="#">
                    <f:selectItem itemLabel="Select One" itemValue=""/>
                    <f:selectItem itemLabel="Option1" itemValue="Option1"/>
                    <f:selectItem itemLabel="Option2" itemValue="Option2"/>
                    <f:selectItem itemLabel="Option3" itemValue="Option3"/>
                    <f:facet name="footer">
                        <p:divider styleClass="mt-0" />
                        <h:outputText value="3 options" style="font-weight:bold;"/>
                    </f:facet>
                </p:selectOneMenu>
            </div>

            <div class="field col-12 md:col-4">
                <p:outputLabel for="@next" value=": Type"/>
                <p:selectOneMenu id="option2" value="#">
                    <f:selectItem itemLabel="Select One" itemValue=""/>
                    <f:selectItem itemLabel="Option1" itemValue="Option1"/>
                    <f:selectItem itemLabel="Option2" itemValue="Option2"/>
                    <f:selectItem itemLabel="Option3" itemValue="Option3"/>
                    <f:facet name="footer2">
                        <p:divider styleClass="mt-0" />
                        <h:outputText value="3 options" style="font-weight:bold;"/>
                    </f:facet>
                </p:selectOneMenu>
            </div>
            
            <div class="field col-12 md:col-4">
            <p:outputLabel for="@next" value=": Contient le mot clé :"/>
                <div class="ui-inputgroup">               	
                    <p:inputText placeholder="Keyboard"/>
                    <p:commandButton icon="pi pi-search" styleClass="ui-button-warning"/>
                </div>
            </div>            
            
            
            
         </div>
      
            
            
</p:fieldset>

<p:toolbar>
     <p:toolbarGroup align="right">
		
       
             
            <p:commandButton 
                 action="#{evenementBean.nouvelEvenement()}"  
                 value="Nouveau"  icon="pi pi-plus-circle"                             	
                 oncomplete="PF('popCreate').show()"
                 update="form"
                 styleClass="rounded-button ui-button-success mr-2 mb-2" />
       
	</p:toolbarGroup>
</p:toolbar>       
       
       
       
			   <div class="col-12">
			     <div class="grid">
	                <div class="col-12">
	                    
	                    
	                    <p:dataTable var="obj" value="#{contratBean.listeContrat}" 
	                                 styleClass="p-datatable-gridlines p-datatable-sm" 
	                                 scrollable="true" scrollHeight="300px">
	                                 
	                                 

                            <p:column headerText="Code" sortBy="#{obj.id}"  >
                                <h:outputText value="#{obj.id}" />
                            </p:column>
                            
                            <p:column headerText="Date debut"  sortBy="#{evenementBean.formatDateFr(obj.datedebut)}"   >
                                <h:outputText value="#{evenementBean.formatDateFr(obj.dateFin)}" />
                            </p:column>  
                            
                            <p:column headerText="Date fin" sortBy="#{evenementBean.formatDateFr(obj.dateFin)}"  >
                                <h:outputText value="#{evenementBean.formatDateFr(obj.dateFin)}" />
                            </p:column> 
                            <p:column headerText="Demandeur" sortBy="#{obj.demandeur.personne.nom}"  >
                                <h:outputText value="#{obj.demandeur.personne.nom} #{obj.demandeur.personne.prenom}" />
                            </p:column>  
                            <p:column headerText="Employeur" sortBy="#{obj.morale.raisonSociale}"  >
                                <h:outputText value="#{obj.morale.raisonSociale}" />
                            </p:column>                              
                            
                            <p:column headerText="Statut"  styleClass="text-right"   >
                            	<p:badge 
								    value="#{obj.statut == 0 ? 'Initié' : (obj.statut == 1 ? 'Cloturé' : 'Annulé')}"
								    severity="#{obj.statut == 0 ? 'info' : (obj.statut == 1 ? 'success' : 'danger')}"/>
                            	
                            </p:column>                              
                            <p:column headerText=""  styleClass="text-right"  >
                                <div style="text-align:center">
								    <p:commandButton
								        action="#{contratBean.contratCapteVoulu(obj)}"
								        icon="pi pi-pencil"
								        update="form"
								        oncomplete="PF('popUpNote').show()"
								        style="margin-right:10px;" /> <!-- espace à droite -->
								
								    <p:commandButton
								        action="#{contratBean.contratCapteVoulu(obj)}"
								        icon="pi pi-info-circle"
								        update="form"
								        oncomplete="PF('popUp').show()" />
								</div>
								                                
                                
                            </p:column>                          
                                                                           
	                    </p:dataTable>
	                    
<!-- MODAL POP UP -->


	                    
<!-- Fin MODAL POP UP -->	

                    
	                </div>
            	</div>
			</div>          	    
		    		          
<!-- popUp NOUVEL EVENEMENT -->		          
		    
		    
		    
		    
		    
		    
		    

		    
		    
		    
		    
		    
		    
		    
		    
		    
		    
		    
		    
		    
		          
		          
    <p:dialog header=" ::: NOUVEAU > Contrat"
			          widgetVar="popCreate"
			          modal="true"
			          width="80%"
			          height="460px">


<p:toolbar>


  

   <p:toolbarGroup align="right">
                    <div  style="text-align:right">  
                        <p:commandButton  oncomplete="PF('popCreate').hide()"
                            value="Annuler"  icon="pi pi-bars" styleClass="rounded-button ui-button-danger mr-2 mb-2" />
                     
                        <p:commandButton value="Créer le contrat"
                            action="#{contratBean.creeContrat()}" styleClass="rounded-button ui-button-success"/>
                    </div>
	</p:toolbarGroup>
</p:toolbar>

   					<p:tabView dynamic="true" cache="true" id="tabview">

        <!-- ================= ONGLET Général ================= -->
              
                  
        <p:tab title="Demanadeur">

            <div class="ui-fluid formgrid grid">

                <!-- Liste Demandeurs -->
                
                <div class="field col-12 md:col-6">
                   <p:dataTable id="listaDemandeur"
				             var="obj"
				             value="#{contratBean.listeDemandeur}"
				             rows="10"
				             scrollable="true"
				             scrollHeight="300px"
				             paginator="true"
				             paginatorPosition="bottom"
				             styleClass="ui-datatable-striped ui-datatable-sm ui-datatable-gridlines listaTable"
				             reflow="true">
				
				    <p:column headerText="Nom et prénom"
				              sortBy="#{obj.personne.nom}"
				              filterBy="#{obj.personne.nom}">
				        <h:outputText
				            value="#{obj.personne.nom} #{obj.personne.prenom}"/>
				    </p:column>
				
				    <p:column style="text-align:center; width:30px">
				        <p:commandButton icon="pi pi-plus"
				                         disabled="#{contratBean.demandeurDejaAjouter(obj)}"
				                         process="@this"
				                         update="listaDemandeur form:tabview:listbDemandeur"
				                         action="#{contratBean.ajouterDemandeur(obj)}"
				                         styleClass="rounded-button ui-button-primary"/>
				    </p:column>
				
				</p:dataTable>
                   
                </div>

                <!-- Liste Demandeurs conviés -->
                
                <div class="field col-12 md:col-6">
                    <p:dataTable id="listbDemandeur"
                                 var="obj"
                                 value="#{contratBean.listeDemandeurChoisi}"
                                 rows="10"
                                 scrollable="true"
                                 scrollHeight="300"
                                 
                                 paginator="true"
                                 paginatorPosition="bottom"
                                 styleClass="ui-datatable-striped ui-datatable-sm ui-datatable-gridlines convieTable"
                                 reflow="true">

                        <p:column style="text-align:center; width:30px">
		                          <p:commandButton icon="pi pi-minus"
		                 process="@this"
		                 update="@(.listaTable) @(.convieTable)"
		                 action="#{contratBean.retirerDemandeur(obj)}"
		                 styleClass="rounded-button ui-button-danger"/>


                           
                           
                        </p:column>

                        <p:column headerText="Nom et prénom"
                                  sortBy="#{obj.personne.nom}"
                                  filterBy="#{obj.personne.nom}">
                            <h:outputText
                                value="#{obj.personne.nom} #{obj.personne.prenom}"/>
                        </p:column>


                    </p:dataTable>
                </div>

            </div>
        </p:tab>
              
                   
        <p:tab title="Employeur">

            <div class="ui-fluid formgrid grid">

                <!-- Liste Partenaires -->
                <div class="field col-12 md:col-6">
                    <p:dataTable id="listaPartenaire"
                                 var="obj"
                                 value="#{contratBean.listeMorale}"
                                 rows="10"
                                 scrollable="true"
                                 scrollHeight="300"
                                 paginator="true"
                                 paginatorPosition="bottom"
                                 styleClass="ui-datatable-striped ui-datatable-sm ui-datatable-gridlines listcTable"
                                 reflow="true">

                        <p:column headerText="Raison sociale"
                                  sortBy="#{obj.raisonSociale}"
                                  filterBy="#{obj.raisonSociale}">
                            <h:outputText
                                value="#{obj.raisonSociale}"/>
                        </p:column>

                        <p:column style="text-align:center; width:30px">
                        
                        <p:commandButton icon="pi pi-plus"
				                         disabled="#{contratBean.moraleDejaAjouter(obj)}"
				                         process="@this"
				                         update="listaPartenaire form:tabview:listbPartenaire"
				                         action="#{contratBean.ajouterMorale(obj)}"
				                         styleClass="rounded-button ui-button-primary"/>
                        
                            
                        </p:column>
                    </p:dataTable>
                </div>

                <!-- Liste Partenaires conviés -->
                
                <div class="field col-12 md:col-6">
                    <p:dataTable id="listbPartenaire"
                                 var="obj"
                                 value="#{contratBean.listeMoraleChoisie}"
                                 rows="10"
                                 scrollable="true"
                                 scrollHeight="300"
                                 paginator="true"
                                 paginatorPosition="bottom"
                                 styleClass="ui-datatable-striped ui-datatable-sm ui-datatable-gridlines listdTable"
                                 reflow="true">


                        <p:column style="text-align:center; width:30px">
                        
                              <p:commandButton icon="pi pi-minus"
		                 process="@this"
		                 update="@(.listcTable) @(.listdTable)"
		                 action="#{contratBean.retirerMorale(obj)}"
		                 styleClass="rounded-button ui-button-danger"/>
                            
                        </p:column>

                        <p:column headerText="Nom et prénom"
                                  sortBy="#{obj.raisonSociale}"
                                  filterBy="#{obj.raisonSociale}">
                            <h:outputText
                                value="#{obj.raisonSociale}"/>
                        </p:column>

                    </p:dataTable>
                </div>

            </div>
        </p:tab>
              
          <p:tab title="Contrat">

    <div><hr /></div>

    <p:toolbarGroup align="right">

        <h5>
            <p:outputLabel value="Choix du type de contrat : " />
        </h5>

        <p:selectOneMenu id="typeContrat"
                         value="#{contratBean.typeContrat}"
                         filter="true"
                         converter="contratConverter">

            <f:selectItem itemLabel="Sélectionner" itemValue="-1" noSelectionOption="true"/>
            <f:selectItems value="#{contratBean.listeTypeContrat}" var="obj"
                           itemLabel="#{obj.libelle}" itemValue="#{obj}"/>

        </p:selectOneMenu>

    </p:toolbarGroup>

    <div class="ui-fluid formgrid grid">

        <!-- Panel contenant les dates, affiché seulement si visible -->
       

            <div class="field col-12 md:col-4">
                <b>: Date début</b>
                <p:calendar id="datedebut"
                            value="#{contratBean.datedebut}"
                            pattern="dd/MM/yyyy"
                            showIcon="true"
                            placeholder="de ?" />
            </div>

            <div class="field col-12 md:col-4"
                 >
                <b>: Date fin</b>
                <p:calendar id="datefin"
                            value="#{contratBean.dateFin}"
                            pattern="dd/MM/yyyy"
                            showIcon="true"
                            placeholder="à ?" />
            </div>

      

        <!-- Salaire, toujours visible -->
        <div class="field col-12 md:col-4">
            <b>: Salaire</b>
            <p:inputText value="#{contratBean.salaire}"
                         placeholder="Salaire du contrat" />
        </div>

    </div>
</p:tab>
          
    

        <!-- ================= ONGLET PARTENAIRES ================= -->
   

    </p:tabView>
         
 <!-- command bouttons -->
                         
</p:dialog>
             

                   			
<!-- popUp DETAIL EVENEMENT? BOUTON détail-->	


              <p:dialog header="::: Détail du contrat" widgetVar="popUp"  width="90%" >
		         <h:panelGrid columns="1">
			        <h:outputText value=" Intitulé : (N° #{contratBean.contratCapte.id})"  styleClass="text-green-500 font-medium" />
			     </h:panelGrid>
		    
                    <div class="ui-fluid formgrid grid">
                 
           <p:tabView dynamic="true" cache="true" >
           
             ================= ONGLET GENERAL =================
             
           <p:tab title="Général" >

                    <div class="ui-fluid formgrid grid">
 
    <!-- Date du rendez-vous -->
    <div class="field col-12 md:col-4">
        <b>Date debut :</b>
        <p:calendar 
            value="#{contratBean.contratCapte.datedebut}"
            pattern="dd/MM/yyyy"
            showIcon="true"
            disabled="true" />
    </div>

    <div class="field col-12 md:col-4">
        <b>Date fin :</b>
        <p:calendar 
            value="#{contratBean.contratCapte.dateFin}"
            pattern="dd/MM/yyyy"
            showIcon="true"
            disabled="true" />
    </div>

    <!-- Lieu -->
    <div class="field col-12 md:col-4">
        <b>Salaire :</b>
        <p:inputText 
            value="#{contratBean.contratCapte.salaire}"
            placeholder="Lieu"
            disabled="true" />
    </div>
   <div class="field col-12 md:col-4">
        <b>Employeur :</b>
        <p:inputText 
            value="#{contratBean.contratCapte.morale.raisonSociale}"
             disabled="true"
           />
    </div>
   

   </div>                           
        </p:tab>
           

        ================= ONGLET DEMANDEURS =================
         <p:tab title="Note">

    <!-- container fluid, sans padding par défaut -->
    <div class="ui-g ui-fluid full-width-container">

       <p:panel header="Historique des notes" styleClass="full-width-panel">

    <div class="timeline-scroll">

        <ui:repeat value="#{contratBean.contratCapte.listeNoteContrat}" var="note">

            <div class="timeline-item">

                <div class="timeline-date">
                    <i class="pi pi-clock" style="margin-right:5px;"></i>
                    <span class="date-label">Date :</span>
                    <h:outputText value="#{note.dateNote}">
                        
                    </h:outputText>
                </div>

                <div class="timeline-content">
                    <span class="created-by">Créé par :</span>
                    <b><i class="pi pi-user" style="margin-right:5px;"></i> #{note.utilisateur.nom} #{note.utilisateur.nomprenom}</b>
                    <p class="note-text">#{note.observation}</p>
                </div>

            </div>

        </ui:repeat>

    </div>

</p:panel>


    </div>

</p:tab>
         


    </p:tabView>
                                                                                          
    </div>	
</p:dialog> 

      <p:dialog header="::: Note sur le contrat" widgetVar="popUpNote"  width="90%" >
		         <h:panelGrid columns="1">
			        <h:outputText value=" Intitulé : (N° #{contratBean.contratCapte.id})"  styleClass="text-green-500 font-medium" />
			     </h:panelGrid>
		    
                    <div class="ui-fluid formgrid grid">
                     <div class="field col-12">
				                <h:outputLabel for="observation" value="Observation :" />
				                <p:inputTextarea id="observation" value="#{contratBean.observationNote}" 
				                                 rows="5" cols="40" autoResize="true"
				                                 placeholder="Entrez vos observations ici" />
				            </div>
				            
                    <div  style="text-align:right">  
                        
                     
                        <p:commandButton value="Enregistrer"
                            action="#{contratBean.creeNoteContrat()}" styleClass="rounded-button ui-button-success"/>
                    </div>
	
                                                                                          
                  </div>	
      </p:dialog> 


			
		</h:form>	 
		</div>	
     
        </div>
    </ui:define>
</ui:composition>